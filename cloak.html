<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
 <meta charset="utf-8">
 <title>Adventure Prompt Runner</title>	
 <style>
	body {
		Font-family: serif;
		Font-size: 16pt;
		Color: black;
		Background-color: tan;
		Margin: 0;
		Padding: 0;
		Position: fixed;
		Top: 0;
		Left: 0;
		Right: 0;
		Bottom: 0;
	}
	
	h1, h2 { Font-family: sans-serif; }
	
	.page-frame {
		Width: 50%;
		Height: 90%;
		Float: left;
	}
	
	.page-content {
		Height: 90%;
		Margin: 1em;
		Padding: 1em;
		Overflow: auto;
		Line-height: 1.5em;
		/*Text-align: justify;*/
		Background-color: white;
		Box-shadow: 0.5ex 0.5ex 0.5ex saddlebrown;
	}
	
	#toolbar {
		Position: fixed;
		Bottom: 0;
		Width: 60%;
		Left: 20%;
		Padding: 0.5ex 0;
		Text-align: center;
	}
	
	.page-content p { Text-indent: 3ex; }
	.title-page p, .edition-notice p { Text-indent: 0; }
	p.ending {
		Text-indent: 0;
		Text-align: center;
		Font-weight: bold;
	}
	
	.title-page { Text-align: center; }
	
	button {
		Font-family: sans-serif;
		Font-weight: bold;
		Font-size: 12pt;
		Color: white;
		Background-color: saddlebrown;
		Padding: 0.5ex 1em;
		Margin: 0.5ex;
		Border-radius: 1em;
		/*Width: 6em;*/
	}
	
	button:disabled { Opacity: 0.5; }
	
	.status-line, dt {
		Background-color: black;
		Color: white;
		Font-weight: bold;
		Font-family: monospace;
		Font-size: 12pt;
	}
	
	.status-line { Text-align: right; }
 </style>
</head>

<body>

<div class="page-frame">
 <div id="verso-page" class="page-content">
  Welcome to Adventure Prompt, an experimental (as of 6 Nov 2016) engine for interactive fiction; this is the runner, or interpreter &mdash; the half that allows you to actually play games.
 </div>
</div>

<div class="page-frame">
 <div id="recto-page" class="page-content">
  <div class="title-page">
   <h1>Adventure Prompt</h1>
   <p>an interactive fiction engine
   <p>by
   <p><b>Felix Ple≈üoianu</b>
   <form id="file-browser">
    <label>
     Pick a story file from your computer:
     <input type="file" id="local-file">
    </label>
   </form>
  </div>
 </div>
</div>

<div id="toolbar">
 <button type="button" id="wait-button" disabled>wait</button>
 <button type="button" id="undo-button" disabled>undo</button>
 <button type="button" id="restart-button" disabled>restart</button>
</div>

<script>
var game_text = "{}";
var game_data = {"config": {"use_score": true, "banner": "Hurrying through the rainswept November night, you're glad to see the bright lights of the Opera House. It's surprising that there aren't more people about but, hey, what do you expect in a cheap demo game...?", "max_score": 10.0}, "objects": {"cr": {"score": 5.0, "name": "Cloakroom", "link": "hook", "type": "room", "description": "The walls of this small room were clearly once lined with hooks, though now only one remains. The exit is a door to the east."}, "foyer-s": {"lock": "-cloak", "name": "south", "link": "bar", "location": "foyer", "type": "exit", "failure": "As you approach the doorway, all light seems to vanish. You backpedal in a hurry."}, "cr-e": {"location": "cr", "type": "exit", "name": "east", "link": "foyer"}, "hero": {"location": "foyer", "type": "actor", "description": "As good-looking as ever.", "name": "me"}, "cloak": {"location": "hero", "type": "thing", "description": "A handsome cloak, of velvet trimmed with satin, and slightly spattered with raindrops. Its blackness is so deep that it almost seems to suck light from the room.", "name": "Velvet cloak", "drop": "As you let go of the cloak, it flies through the air, only to end up hanging from the hook."}, "foyer-w": {"location": "foyer", "type": "exit", "name": "west", "link": "cr"}, "hook": {"lock": true, "name": "Small brass hook", "location": "cr", "type": "thing", "description": "It's just a small brass hook, screwed to the wall.", "failure": "You consider getting a souvenir, but it's too well fastened."}, "foyer": {"nodrop": "This isn't the best place to leave a smart cloak lying around.", "name": "Foyer of the Opera House", "type": "room", "description": "You are standing in a spacious hall, splendidly decorated in red and gold, with glittering chandeliers overhead. The entrance from the street is to the north, and there are doorways south and west.", "sticky": true}, "bar-n": {"location": "bar", "type": "exit", "name": "north", "link": "foyer"}, "foyer-n": {"lock": true, "name": "north", "link": null, "location": "foyer", "type": "exit", "failure": "You've only just arrived, and besides, the weather outside seems to be getting worse."}, "bar": {"score": 5.0, "name": "Bar", "success": "The message, neatly marked in the sawdust, reads... YOU HAVE WON!", "ending": true, "type": "room", "description": "The bar, much rougher than you'd have guessed after the opulence of the foyer to the north, is completely empty. There seems to be some sort of message scrawled in the sawdust on the floor."}}, "meta": {"subtitle": "A basic IF demonstration", "title": "Cloak of Darkness", "date": "2016", "author": "Roger Firth", "license": "Adventure Prompt version by Felix Ple\u015foianu"}};

var verso;
var recto;

var wait_button, undo_button, restart_button;

function say(page, content) {
	if (typeof content === "string")
		page.appendChild(document.createTextNode(content));
	else
		page.appendChild(content);
}

function tag(name, content) {
	var t = document.createElement(name);
	if (content !== undefined) {
		if (typeof content === "string")
			t.innerHTML = content;
		else
			t.appendChild(content);
	}
	return t;
}

function title_page(metadata) {
	var page = tag("div");
	page.className = "title-page";
	say(page, tag("h1", metadata.title));
	say(page, tag("p", metadata.subtitle));
	say(page, tag("p", "by"));
	say(page, tag("p", tag("b", metadata.author)));
	
	var start = tag("button", "Turn the page");
	start.type = "button";
	start.addEventListener("click", start_game, false);
	say(page, tag("p", start));
	
	return page;
}

function edition_notice(metadata) {
	var page = tag("div");
	page.className = "edition-notice";
	say(page, tag("div", tag("b", metadata.title)));
	say(page, tag("div", metadata.subtitle));
	say(page, tag("p", metadata.author));
	say(page, tag("p", metadata.date));
	say(page, tag("p", metadata.license));
	say(page, tag("p", metadata.ifid));
	return page;
}

function status_line() {
	var line = tag("p");
	line.className = "status-line";
	say(line, "Turns: " + game_data.meta.turns);
	if (game_data.config.use_score)
		say(line, " Score: " + game_data.meta.score
			+ "/" + (game_data.config.max_score || "?"));
	return line;
}

function visible_objects() {
	var list = tag("dl");
	
	say(list, tag("dt", "You see:"));
	say(list, tag("dd",
		object_list(find_objects_in(
			game_data.objects.hero.location))));
	say(list, tag("dt", "You are carrying:"));
	say(list, tag("dd", object_list(find_objects_in("hero"))));
	
	return list;
}

function find_objects_in(loc) {
	var found = {};
	for (var i in game_data.objects) {
		var obj = game_data.objects[i];
		if (obj.location !== loc)
			continue;
		else if (obj.type === "exit")
			continue;
		else if (i === "hero")
			continue;
		else
			found[i] = obj;
	}
	return found;
}

function object_list(group) {
	var list = tag("ul");
	for (var i in group) {
		var item = tag("li", group[i].name);
		var actions = object_actions(i, group[i]);
		for (var j in actions)
			say(item, actions[j]);
		say(list, item);
	}
	return list;
}

function object_actions(obj_id, obj) {
	var list = [];
	switch (obj.type) {
		case "thing":
			list.push(action_button(
				"look", obj_id, handle_look_at));
			if (obj.location === "hero")
				list.push(action_button(
					"drop", obj_id, handle_drop));
			else
				list.push(action_button(
					"take", obj_id, handle_take));
	}
	return list;
}

function action_button(label, obj_id, handler) {
	var button = document.createElement("button");
	button.type = "button";
	button.setAttribute("data-target", obj_id);
	button.innerHTML = label;
	button.addEventListener("click", handler, false);
	return button;
}

function handle_look_at() {
	var obj_id = this.getAttribute("data-target");
	var obj = game_data.objects[obj_id];

	game_data.meta.turns++;
	verso.innerHTML = "";
	say(verso, status_line());
	look();
	
	recto.innerHTML = "";
	if (!obj.visited && obj.initial)
		say(verso, tag("p", obj.initial));
	else if (obj.description) {
		say(recto, tag("p", obj.description));
	} else {
		say(recto, tag("p", "You see nothing special."));
	}
	say(recto, object_list(find_objects_in(obj_id)));
	say(recto, visible_objects());
}

function handle_take() {
	var obj_id = this.getAttribute("data-target");
	var obj = game_data.objects[obj_id];
	
	game_data.meta.turns++;
	verso.innerHTML = "";
	say(verso, status_line());
	look();
	
	recto.innerHTML = "";
	if (pass_lock("hero", obj.lock)) {
		obj.location = "hero";
		obj.visited = true;
		if (obj.success)
			say(recto, tag("p", obj.success));
		else
			say(recto, tag("p", "Taken."));
	} else if (obj.failure) {
		say(recto, tag("p", obj.failure));
	} else {
		say(recto, tag("p", "You can't seem to pick that up."));
	}
	say(recto, visible_objects());
}

function handle_drop() {
	var obj_id = this.getAttribute("data-target");
	var obj = game_data.objects[obj_id];
	var room_id = game_data.objects.hero.location;
	var here = game_data.objects[room_id];

	game_data.meta.turns++;
	verso.innerHTML = "";
	say(verso, status_line());
	look();
	
	recto.innerHTML = "";
	if (obj.sticky) {
		if (obj.nodrop)
			say(recto, tag("p", obj.nodrop));
		else
			say(recto, tag("p",
				"You try to drop that, but can't seem to."));
	} else if (here.sticky) {
		if (here.nodrop)
			say(recto, tag("p", here.nodrop));
		else
			say(recto, tag("p",
				"You try to drop that, but can't seem to."));
	} else {
		if (here.link)
			obj.location = here.link;
		else
			obj.location = room_id;
		if (obj.drop)
			say(recto, tag("p", obj.drop));
		else
			say(recto, tag("p", "Dropped."));
	}
	say(recto, visible_objects());
}

function look() {
	var obj = game_data.objects;
	var me = obj.hero;
	var here = obj[me.location];

	say(verso, tag("div", tag("b", here.name)));
	if (!here.visited && here.initial)
		say(verso, tag("p", here.initial));
	else
		say(verso, tag("p", here.description));

	here.visited = true;
	
	say(verso, success_message(here));
	say(verso, exit_list(me.location));
	
	if (here.ending)
		end_game();
}

function success_message(obj) {
	if (obj.ending) {
		if (obj.success)
			var succ = tag("p", "*** " + obj.success + " ***");
		else
			var succ = tag("p", "*** The End ***");
		succ.className = "ending";
		return succ;
	} else {
		return tag("p", obj.success);
	}
}

function exit_list(room_id) {
	var list = tag("div", "Exits: ");
	var obj = game_data.objects;
	for (var i in obj) {
		if (obj[i].location !== room_id)
			continue;
		else if (obj[i].type !== "exit")
			continue;

		var btn = action_button(obj[i].name, i, handle_exit);
		if (!obj[i].visited && obj[i].initial)
			btn.title = obj[i].initial;
		else if (obj[i].description)
			btn.title = obj[i].description;
		say(list, btn);
	}
	return list;
}

function handle_exit() {
	var exit_id = this.getAttribute("data-target");
	var exit_obj = game_data.objects[exit_id];
	
	if (exit_obj.visited && exit_obj.sticky) {
		pass_through(exit_obj);
	} else if (pass_lock("hero", exit_obj.lock)) {
		pass_through(exit_obj);
	} else {
		say(verso, tag("p", exit_obj.failure));
	}
}

function pass_lock(actor_id, lock) {
	if (lock === undefined) {
		return true;
	} else if (lock === true) {
		return false;
	} else if (typeof lock === "string") {
		if (lock[0] === "+") {
			var key_id = lock.substr(1);
			var key = game_data.objects[key_id];
			return key.location === actor_id;
		} else if (lock[0] === "-") {
			var key_id = lock.substr(1);
			var key = game_data.objects[key_id];
			return key.location !== actor_id;
		} else {
			return lock === actor_id;
		}
	} else if (typeof lock === "object") {
		var objs = game_data.objects
		for (var i in find_objects_in(actor_id)) {
			for (var j in lock) {
				if (objs[i][j] === lock[j])
					return true;
			}
		}
		return false;
	}
}

function pass_through(exit_obj) {
	game_data.objects.hero.location = exit_obj.link;
	exit_obj.visited = true;

	game_data.meta.turns++;
	score_object(exit_obj.link);
	verso.innerHTML = "";
	say(verso, status_line());
	say(verso, tag("p", exit_obj.success));
	look();
	
	recto.innerHTML = "";
	say(recto, visible_objects());
}

function score_object(obj_id) {
	var obj = game_data.objects[obj_id];
	if (obj.score && !obj.visited)
		game_data.meta.score += obj.score;
}

function start_game() {
	game_data.meta.turns = 0;
	game_data.meta.score = 0;

	verso.innerHTML = "";
	say(verso, status_line());
	say(verso, tag("p", game_data.config.banner));
	look();
	
	recto.innerHTML = "";
	say(recto, visible_objects());
	
	wait_button.disabled = false;
	restart_button.disabled = false;
}

function end_game() {
	var buttons = document.getElementsByTagName("button");
	for (var i in buttons)
		buttons[i].disabled = true;
	document.getElementById("restart-button").disabled = false;
}

window.addEventListener("load", function () {
	verso = document.getElementById("verso-page");
	recto = document.getElementById("recto-page");
	
	wait_button = document.getElementById("wait-button");
	undo_button = document.getElementById("undo-button");
	restart_button = document.getElementById("restart-button");

	var input = document.getElementById("local-file");
	input.addEventListener("change", function () {
		var file = this.files[0];
		var reader = new FileReader();
		reader.onload = function () {
			try {
				game_text = reader.result;
				game_data = JSON.parse(reader.result);
				//console.log(game_data.objects.hero);
				verso.innerHTML = "";
				say(verso, edition_notice(game_data.meta));
				recto.innerHTML = "";
				say(recto, title_page(game_data.meta));
			} catch (e) {
				console.log(e);
				alert("Can't load story file. See console.");
			}
		};
		reader.readAsText(file);
	}, false);
	
	wait_button.addEventListener("click", function () {
		game_data.meta.turns++;
		verso.innerHTML = "";
		say(verso, status_line());
		say(verso, tag("p", "You wait. Time passes..."));
		look();
		
		recto.innerHTML = "";
		say(recto, visible_objects());
	}, false);
	
	undo_button.addEventListener("click", function () {
		
	}, false);
	
	restart_button.addEventListener("click", function () {
		game_data = JSON.parse(game_text);
		verso.innerHTML = "";
		say(verso, edition_notice(game_data.meta));
		recto.innerHTML = "";
		say(recto, title_page(game_data.meta));
	}, false);
	
	if (game_data) {
		game_text = JSON.stringify(game_data);
		verso.innerHTML = "";
		say(verso, edition_notice(game_data.meta));
		recto.innerHTML = "";
		say(recto, title_page(game_data.meta));
	}
}, false);
</script>

</body>	
</html>
